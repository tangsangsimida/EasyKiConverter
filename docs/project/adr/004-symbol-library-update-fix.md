# ADR-004: угдтЈит║ЊТЏ┤Тќ░т»╝тЄ║С┐«тцЇ

## уіХТђЂ
ти▓ТјЦтЈЌ (Accepted)

## ТЌЦТюЪ
2026-01-21

## СИіСИІТќЄ

тюе v3.0.0 уЅѕТюгСИГ№╝їТѕЉС╗гт«ъуј░С║єугдтЈит║ЊуџёУ┐йтіатњїТЏ┤Тќ░т»╝тЄ║тіЪУЃйсђѓуёХУђї№╝їтюет«ъжЎЁСй┐ућеСИГтЈЉуј░С║єСИђСИфСИЦжЄЇуџё bug№╝џтйЊСй┐ућеТЏ┤Тќ░т»╝тЄ║тіЪУЃйТЌХ№╝їтѕєСйЊт╝ЈугдтЈи№╝ѕmulti-part symbols№╝ЅуџётГљугдтЈиС╝џУбФжћЎУ»»тю░СйюСИ║уІгуФІуџёжАХт▒ѓугдтЈитГўтюе№╝їт»╝УЄ┤угдтЈит║ЊТа╝т╝Јуа┤тЮЈсђѓ

### тЈЉуј░уџёжЌ«жбў

#### жЌ«жбў 1№╝џТЏ┤Тќ░ТеАт╝ЈтЈѓТЋ░ТюфС╝ажђњ ­Ъћ┤ СИЦжЄЇ

**жЌ«жбўТЈЈУ┐░**№╝џ
- `ExportService_Pipeline::mergeSymbolLibrary()` Тќ╣Т│ЋСИГ№╝ї`updateMode` тЈѓТЋ░Т▓АТюЅУбФТГБуА«С╝ажђњу╗Ў `exportSymbolLibrary` Тќ╣Т│Ћ
- тјЪС╗БуаЂтЈфСй┐ућеС║є `overwriteExistingFiles` ТЮЦУ«Йуй« `appendMode`№╝їт┐йуЋЦС║є `updateMode`
- т»╝УЄ┤ТЏ┤Тќ░т»╝тЄ║ТЌХ№╝їТЅђТюЅти▓тГўтюеуџёугдтЈижЃйУбФУи│У┐Є№╝їУђїСИЇТў»УбФУдєуЏќ

**тй▒тЊЇУїЃтЏ┤**№╝џ
- ТЅђТюЅСй┐ућеТЏ┤Тќ░ТеАт╝ЈуџёугдтЈит║Њт»╝тЄ║
- ућеТѕиТЌаТ│ЋТЏ┤Тќ░ти▓тГўтюеуџёугдтЈи

**С╗БуаЂСйЇуй«**№╝џ
- `src/services/ExportService_Pipeline.cpp:395-397`

**уц║СЙІ**№╝џ
```cpp
// тјЪС╗БуаЂ№╝ѕжћЎУ»»№╝Ѕ
bool appendMode = !m_options.overwriteExistingFiles;
bool success = exporter.exportSymbolLibrary(m_symbols, m_options.libName, libraryPath, appendMode);

// С┐«тцЇтљј№╝ѕТГБуА«№╝Ѕ
bool appendMode = !m_options.overwriteExistingFiles;
bool updateMode = m_options.updateMode;
bool success = exporter.exportSymbolLibrary(m_symbols, m_options.libName, libraryPath, appendMode, updateMode);
```

---

#### жЌ«жбў 2№╝џтГљугдтЈиУ»єтѕФСИЇтЄєуА« ­Ъћ┤ СИЦжЄЇ

**жЌ«жбўТЈЈУ┐░**№╝џ
- тјЪС╗БуаЂСй┐ућеу«ђтЇЋуџётГЌугдСИ▓тї╣жЁЇ `startsWith(parentSymbolName + "_")` ТЮЦУ»єтѕФтГљугдтЈи
- У┐ЎуДЇТќ╣Т│ЋТЌаТ│ЋтЄєуА«тї║тѕєтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈиуџётГљугдтЈи
- тЈ»УЃйУ»»тѕатЁХС╗ќугдтЈиуџётГљугдтЈи

**тй▒тЊЇУїЃтЏ┤**№╝џ
- ТиитљѕугдтЈит║Њ№╝ѕтљїТЌХтїЁтљФтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈи№╝Ѕ
- угдтЈитљЇуД░тїЁтљФСИІтѕњу║┐уџёугдтЈи

**С╗БуаЂСйЇуй«**№╝џ
- `src/core/kicad/ExporterSymbol.cpp:195-206`

**уц║СЙІтю║ТЎ»**№╝џ
```
тЂЄУ«ЙугдтЈит║ЊСИГтїЁтљФ№╝џ
- тѕєСйЊт╝ЈугдтЈи A№╝џMCU_A№╝їТюЅтГљугдтЈи MCU_A_1_1, MCU_A_2_1
- тЇЋСйЊугдтЈи B№╝џResistor_B№╝їТюЅтГљугдтЈи Resistor_B_0_1

тйЊТЏ┤Тќ░ MCU_A ТЌХ№╝їтјЪС╗БуаЂС╝џ№╝џ
1. У»єтѕФ MCU_A СИ║УдЂУдєуЏќуџёугдтЈи
2. ТЪЦТЅЙС╗Ц MCU_A_ т╝ђтц┤уџётГљугдтЈит╣ХТаЄУ«░тѕажЎц
3. СйєтдѓТъю Resistor_B_0_1 УбФжћЎУ»»У»єтѕФ№╝їтЈ»УЃйт»╝УЄ┤Та╝т╝Јуа┤тЮЈ
```

---

#### жЌ«жбў 3№╝џтГцуд╗тГљугдтЈиТюфтѕажЎц ­Ъћ┤ СИЦжЄЇ

**жЌ«жбўТЈЈУ┐░**№╝џ
- тюеТЪљС║ЏТЃЁтєхСИІ№╝їтѕєСйЊт╝ЈугдтЈиуџётГљугдтЈитЈ»УЃйУбФжћЎУ»»тю░СйюСИ║жАХт▒ѓугдтЈит»╝тЄ║
- тјЪС╗БуаЂтЈфтѕажЎцС║єуѕХугдтЈитєЁжЃеуџётГљугдтЈи№╝їТ▓АТюЅтѕажЎцСйюСИ║жАХт▒ѓугдтЈитГўтюеуџётГцуд╗тГљугдтЈи
- т»╝УЄ┤ТЏ┤Тќ░тљј№╝їТЌДуџётГцуд╗тГљугдтЈиС╗ЇуёХтГўтюе

**тй▒тЊЇУїЃтЏ┤**№╝џ
- С╣ІтЅЇСй┐ућежћЎУ»»Тќ╣т╝Јт»╝тЄ║уџёугдтЈит║Њ
- угдтЈит║Њу╗ЊТъёСИЇТГБуА«уџёТЃЁтєх

**С╗БуаЂСйЇуй«**№╝џ
- `src/core/kicad/ExporterSymbol.cpp:310-360`

**уц║СЙІтю║ТЎ»**№╝џ
```
тЂЄУ«ЙугдтЈит║ЊСИГтїЁтљФ№╝џ
РюЁ ТГБуА«уџёу╗ЊТъё№╝џ
- уѕХугдтЈи№╝џMCIMX6Y2CVM08AB
  - тГљугдтЈи№╝џMCIMX6Y2CVM08AB_1_1
  - тГљугдтЈи№╝џMCIMX6Y2CVM08AB_2_1

РЮї т«ъжЎЁтГўтюеуџёжћЎУ»»у╗ЊТъё№╝џ
- уѕХугдтЈи№╝џMCIMX6Y2CVM08AB
  - тГљугдтЈи№╝џMCIMX6Y2CVM08AB_1_1
- жАХт▒ѓугдтЈи№╝џMCIMX6Y2CVM08AB_2_1№╝ѕжћЎУ»»№╝Ђ№╝Ѕ

тйЊТЏ┤Тќ░ MCIMX6Y2CVM08AB ТЌХ№╝џ
1. MCIMX6Y2CVM08AB УбФТГБуА«УдєуЏќ
2. MCIMX6Y2CVM08AB_1_1 СйюСИ║тГљугдтЈиУбФТГБуА«тѕажЎцтњїжЄЇТќ░ућЪТѕљ
3. MCIMX6Y2CVM08AB_2_1 СйюСИ║жАХт▒ѓугдтЈиУбФС┐ЮуЋЎ№╝ѕжћЎУ»»№╝Ђ№╝Ѕ
4. Тќ░уџё MCIMX6Y2CVM08AB_2_1 СйюСИ║тГљугдтЈиУбФућЪТѕљ
5. у╗ЊТъю№╝џугдтЈит║ЊСИГтГўтюеСИцСИф MCIMX6Y2CVM08AB_2_1№╝їТа╝т╝Јуа┤тЮЈ
```

## тє│уГќ

ТѕЉС╗гт«ъТќйС║єС╗ЦСИІС┐«тцЇТќ╣ТАѕТЮЦУДБтє│СИіУ┐░жЌ«жбў№╝џ

### С┐«тцЇ 1№╝џС╝ажђњ updateMode тЈѓТЋ░

**жЌ«жбў**№╝џ`updateMode` тЈѓТЋ░Т▓АТюЅУбФТГБуА«С╝ажђњу╗Ў `exportSymbolLibrary` Тќ╣Т│Ћ

**УДБтє│Тќ╣ТАѕ**№╝џ
```cpp
// С┐«тцЇтЅЇ
bool appendMode = !m_options.overwriteExistingFiles;
bool success = exporter.exportSymbolLibrary(m_symbols, m_options.libName, libraryPath, appendMode);

// С┐«тцЇтљј
bool appendMode = !m_options.overwriteExistingFiles;
bool updateMode = m_options.updateMode;
qDebug() << "Merge settings - Append mode:" << appendMode << "Update mode:" << updateMode;
bool success = exporter.exportSymbolLibrary(m_symbols, m_options.libName, libraryPath, appendMode, updateMode);
```

**тй▒тЊЇ**№╝џ
- ТЏ┤Тќ░ТеАт╝Јуј░тюеУЃйтцЪТГБуА«УдєуЏќти▓тГўтюеуџёугдтЈи
- У┐йтіаТеАт╝ЈС╗ЇуёХС┐ЮуЋЎти▓тГўтюеуџёугдтЈи

---

### С┐«тцЇ 2№╝џТћ╣У┐ЏтГљугдтЈиУ»єтѕФжђ╗УЙЉ

**жЌ«жбў**№╝џу«ђтЇЋуџётГЌугдСИ▓тї╣жЁЇТЌаТ│ЋтЄєуА«тї║тѕєтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈиуџётГљугдтЈи

**УДБтє│Тќ╣ТАѕ**№╝џ
```cpp
// ждќтЁѕтѕєТъљуј░ТюЅугдтЈи№╝їуА«т«џтЊфС║ЏТў»тѕєСйЊт╝ЈугдтЈи№╝ѕТюЅтцџСИфтГљугдтЈи№╝Ѕ
QMap<QString, QStringList> parentToSubSymbols; // уѕХугдтЈитљЇ -> тГљугдтЈитѕЌУАе
for (const QString &subSymbolName : subSymbolNames)
{
    // С╗јтГљугдтЈитљЇуД░СИГТЈљтЈќуѕХугдтЈитљЇ
    // тГљугдтЈиТа╝т╝Ј№╝џ{parentName}_{unitNumber}_1
    int lastUnderscore = subSymbolName.lastIndexOf('_');
    if (lastUnderscore > 0)
    {
        int secondLastUnderscore = subSymbolName.lastIndexOf('_', lastUnderscore - 1);
        if (secondLastUnderscore > 0)
        {
            QString parentName = subSymbolName.left(secondLastUnderscore);
            parentToSubSymbols[parentName].append(subSymbolName);
        }
    }
}

// т»╣С║јТ»ЈСИфУбФУдєуЏќуџёуѕХугдтЈи№╝їТћХжЏєтЁХТЅђТюЅтГљугдтЈи
for (const QString &parentSymbolName : overwrittenSymbolNames)
{
    if (parentToSubSymbols.contains(parentSymbolName))
    {
        // У┐ЎТў»СИђСИфтѕєСйЊт╝ЈугдтЈи№╝їтѕажЎцТЅђТюЅтГљугдтЈи
        for (const QString &subSymbolName : parentToSubSymbols[parentSymbolName])
        {
            subSymbolsToDelete.insert(subSymbolName);
            qDebug() << "Marking sub-symbol for deletion (multipart):" << subSymbolName << "(parent:" << parentSymbolName << ")";
        }
    }
    else
    {
        // У┐ЎТў»СИђСИфтЇЋСйЊугдтЈи№╝їТЪЦТЅЙтЁХтГљугдтЈи№╝ѕТа╝т╝Ј№╝џ{parentName}_0_1№╝Ѕ
        QString expectedSubSymbolName = parentSymbolName + "_0_1";
        if (subSymbolNames.contains(expectedSubSymbolName))
        {
            subSymbolsToDelete.insert(expectedSubSymbolName);
            qDebug() << "Marking sub-symbol for deletion (single part):" << expectedSubSymbolName << "(parent:" << parentSymbolName << ")";
        }
    }
}
```

**тй▒тЊЇ**№╝џ
- тЄєуА«тї║тѕєтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈи
- жЂ┐тЁЇУ»»тѕатЁХС╗ќугдтЈиуџётГљугдтЈи
- Тћ»ТїЂТиитљѕугдтЈит║ЊуџёТГБуА«тцёуљє

---

### С┐«тцЇ 3№╝џтѕажЎцтГцуФІуџёжАХт▒ѓтГљугдтЈи

**жЌ«жбў**№╝џСйюСИ║жАХт▒ѓугдтЈитГўтюеуџётГцуд╗тГљугдтЈиТ▓АТюЅУбФтѕажЎц

**УДБтє│Тќ╣ТАѕ**№╝џ
```cpp
// ТБђТЪЦТў»тљдТў»С╗ЦУбФУдєуЏќугдтЈитљЇт╝ђтц┤уџёжАХт▒ѓугдтЈи№╝ѕтЈ»УЃйТў»С╣ІтЅЇжћЎУ»»т»╝тЄ║уџётГљугдтЈи№╝Ѕ
bool isOrphanedSubSymbol = false;
if (!isOverwritten)
{
    for (const QString &parentSymbolName : overwrittenSymbolNames)
    {
        if (symbolName.startsWith(parentSymbolName + "_"))
        {
            isOrphanedSubSymbol = true;
            qDebug() << "Skipping orphaned sub-symbol (top-level):" << symbolName << "(parent:" << parentSymbolName << ")";
            break;
        }
    }
}

// тЈфт»╝тЄ║ТюфУбФУдєуЏќСИћСИЇТў»тГцуд╗тГљугдтЈиуџёугдтЈи
if (!isOverwritten && !isOrphanedSubSymbol)
{
    // т»╝тЄ║угдтЈитєЁт«╣
    out << filteredContent;
    qDebug() << "Keeping existing symbol:" << symbolName;
}
```

**тй▒тЊЇ**№╝џ
- тѕажЎцТЅђТюЅС╗ЦУбФУдєуЏќуѕХугдтЈитљЇт╝ђтц┤уџёжАХт▒ѓугдтЈи
- уА«С┐ЮугдтЈит║Њу╗ЊТъёуџёТГБуА«ТђД
- жЂ┐тЁЇжЄЇтцЇуџётГљугдтЈи

## тљјТъю

### ТГБжЮбтй▒тЊЇ

1. **С┐«тцЇС║єТЏ┤Тќ░т»╝тЄ║тіЪУЃй**
   - ТЏ┤Тќ░ТеАт╝Јуј░тюеУЃйтцЪТГБуА«УдєуЏќти▓тГўтюеуџёугдтЈи
   - ућеТѕитЈ»С╗ЦТЏ┤Тќ░угдтЈит║ЊСИГуџёугдтЈи

2. **тЄєуА«уџётГљугдтЈитцёуљє**
   - ТГБуА«тї║тѕєтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈи
   - тѕєСйЊт╝ЈугдтЈи№╝џтѕажЎцТЅђТюЅтГљугдтЈи№╝ѕ`_1_1`, `_2_1`, ...№╝Ѕ
   - тЇЋСйЊугдтЈи№╝џтЈфтѕажЎц `_0_1` тГљугдтЈи

3. **угдтЈит║Њу╗ЊТъёТГБуА«ТђД**
   - тѕажЎцтГцуФІуџёжАХт▒ѓтГљугдтЈи
   - уА«С┐ЮтГљугдтЈитЈфтюеуѕХугдтЈитєЁжЃетГўтюе
   - жЂ┐тЁЇугдтЈит║ЊТа╝т╝Јуа┤тЮЈ

4. **Тћ»ТїЂТиитљѕугдтЈит║Њ**
   - ТГБуА«тцёуљєтљїТЌХтїЁтљФтѕєСйЊт╝ЈугдтЈитњїтЇЋСйЊугдтЈиуџёугдтЈит║Њ
   - жЂ┐тЁЇУ»»тѕатЁХС╗ќугдтЈиуџётГљугдтЈи

### У┤ЪжЮбтй▒тЊЇ

1. **тцЇТЮѓт║дтбътіа**
   - тГљугдтЈиУ»єтѕФжђ╗УЙЉТЏ┤тіатцЇТЮѓ
   - жюђУдЂтѕєТъљугдтЈит║Њу╗ЊТъё

2. **ТђДУЃйтй▒тЊЇ**
   - жюђУдЂжбЮтцќуџёугдтЈитѕєТъљТГЦжфц
   - тЈ»УЃйуЋЦтЙ«тбътіат»╝тЄ║ТЌХжЌ┤

3. **тљЉтљјтЁ╝т«╣ТђД**
   - тЈ»УЃйжюђУдЂТИЁуљєС╣ІтЅЇт»╝тЄ║уџёжћЎУ»»угдтЈит║Њ
   - ућеТѕитЈ»УЃйжюђУдЂжЄЇТќ░т»╝тЄ║угдтЈит║Њ

## ТЏ┐С╗БТќ╣ТАѕ

### Тќ╣ТАѕ A№╝џСй┐ућеТГБтѕЎУАеУЙЙт╝Јтї╣жЁЇтГљугдтЈи

**ТЈЈУ┐░**№╝џСй┐ућеТГБтѕЎУАеУЙЙт╝ЈТЮЦтї╣жЁЇтГљугдтЈитљЇуД░

**С╝ўуѓ╣**№╝џ
- ТЏ┤уЂхТ┤╗уџёТеАт╝Јтї╣жЁЇ
- тЈ»С╗ЦтцёуљєТЏ┤тцЇТЮѓуџётЉйтљЇУДётѕЎ

**у╝║уѓ╣**№╝џ
- ТГБтѕЎУАеУЙЙт╝ЈТђДУЃйУЙЃти«
- С╗БуаЂтЈ»У»╗ТђДжЎЇСйј

**жђЅТІЕ**№╝џТюфжЄЄуће№╝їтйЊтЅЇТќ╣ТАѕТЏ┤у«ђтЇЋжФўТЋѕ

### Тќ╣ТАѕ B№╝џжЄЇТќ░т»╝тЄ║ТЋ┤СИфугдтЈит║Њ

**ТЈЈУ┐░**№╝џтюеТЏ┤Тќ░ТеАт╝ЈСИІ№╝їт«їтЁежЄЇТќ░т»╝тЄ║угдтЈит║Њ

**С╝ўуѓ╣**№╝џ
- т«ъуј░у«ђтЇЋ
- уА«С┐ЮугдтЈит║Њу╗ЊТъёТГБуА«

**у╝║уѓ╣**№╝џ
- ТђДУЃйУЙЃти«
- ТЌаТ│ЋС┐ЮуЋЎућеТѕиС┐«Тћ╣

**жђЅТІЕ**№╝џТюфжЄЄуће№╝їтйЊтЅЇТќ╣ТАѕТЏ┤жФўТЋѕСИћС┐ЮуЋЎућеТѕиС┐«Тћ╣

## т«ъТќйу╗єУіѓ

### С┐«Тћ╣ТќЄС╗Х

**С┐«тцЇ 1**№╝џ
1. `src/services/ExportService_Pipeline.cpp` - С╝ажђњ `updateMode` тЈѓТЋ░

**С┐«тцЇ 2**№╝џ
1. `src/core/kicad/ExporterSymbol.cpp` - Тћ╣У┐ЏтГљугдтЈиУ»єтѕФжђ╗УЙЉ

**С┐«тцЇ 3**№╝џ
1. `src/core/kicad/ExporterSymbol.cpp` - тѕажЎцтГцуФІуџёжАХт▒ѓтГљугдтЈи

### ТхІУ»ЋжфїУ»Ђ

**ТхІУ»Ћтю║ТЎ»**№╝џ
1. ТЏ┤Тќ░тѕєСйЊт╝ЈугдтЈи
2. ТЏ┤Тќ░тЇЋСйЊугдтЈи
3. ТиитљѕугдтЈит║ЊТЏ┤Тќ░
4. угдтЈит║ЊтїЁтљФтГцуд╗тГљугдтЈиуџёТЃЁтєх

**жбёТюЪу╗ЊТъю**№╝џ
- тѕєСйЊт╝ЈугдтЈиУбФТГБуА«УдєуЏќ№╝їТЅђТюЅтГљугдтЈиУбФТГБуА«ТЏ┤Тќ░
- тЇЋСйЊугдтЈиУбФТГБуА«УдєуЏќ№╝їтГљугдтЈиУбФТГБуА«ТЏ┤Тќ░
- ТиитљѕугдтЈит║ЊСИГ№╝їтЁХС╗ќугдтЈиСИЇтЈЌтй▒тЊЇ
- тГцуд╗тГљугдтЈиУбФТГБуА«тѕажЎц

## уЏИтЁ│ТќЄТАБ

- [ADR-001: MVVM ТъХТъё](001-mvvm-architecture.md)
- [ADR-002: ТхЂТ░┤у║┐т╣ХУАїТъХТъё](002-pipeline-parallelism-for-export.md)
- [ADR-003: ТхЂТ░┤у║┐ТђДУЃйС╝ўтїќ](003-pipeline-performance-optimization.md)
- [угдтЈит»╝тЄ║тЎеТќЄТАБ](../developer/ARCHITECTURE.md)

## тЈѓУђЃУхёТќЎ

- [KiCad угдтЈит║ЊТа╝т╝ЈУДёУїЃ](https://docs.kicad.org/7.0/en/eeschema/eeschema_libs/)
- [угдтЈиу▒╗тъІУ»┤Тўј](https://docs.kicad.org/7.0/en/eeschema/eeschema_symbols/)