name: 'Pull Request Review'

on:
  pull_request:
    types:
      - 'opened'
      - 'reopened'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: 'number'

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'read'
  issues: 'write'
  pull-requests: 'write'
  statuses: 'write'

jobs:
  review-pr:
    if: |-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'pull_request' &&
        (
          github.event.repository.private == true ||
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)
        )
      )
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout PR code'
        uses: 'actions/checkout@v4'

      - name: 'Get PR details'
        id: 'get_pr'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: |-
          set -euo pipefail

          if [[ "${{ github.event_name }}" = "workflow_dispatch" ]]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi

          echo "pr_number=${PR_NUMBER}" >> "${GITHUB_OUTPUT}"
          PR_DATA="$(gh pr view "${PR_NUMBER}" --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)"
          echo "pr_data=${PR_DATA}" >> "${GITHUB_OUTPUT}"
          CHANGED_FILES="$(gh pr diff "${PR_NUMBER}" --name-only)"
          {
            echo "changed_files<<EOF"
            echo "${CHANGED_FILES}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: 'PR Review'
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: 'iflow_cli_pr_review'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.get_pr.outputs.pr_number }}'
          PR_DATA: '${{ steps.get_pr.outputs.pr_data }}'
          CHANGED_FILES: '${{ steps.get_pr.outputs.changed_files }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "3600"
          debug: "true"
          settings_json: |
            {
                "selectedAuthType": "iflow",
                "apiKey": "${{ secrets.IFLOW_API_KEY }}",
                "baseUrl": "https://apis.iflow.cn/v1",
                "modelName": "qwen3-coder-plus",
                "searchApiKey": "${{ secrets.IFLOW_API_KEY }}"
            }
          prompt: |
            ## Role

            你是一个专业的代码审查员。你需要审查代码变更并提供一份详细的中文审查报告。

            ## CRITICAL REQUIREMENTS
            1. 你必须生成一份完整的中文审查报告，包含所有发现的问题
            2. 不要生成多条评论，只生成一条完整的审查报告
            3. 审查报告必须使用中文
            4. 报告应该包含：审查概述、发现的问题（按严重性分类）、一般反馈、改进建议

            ## Steps

            1. 运行这些命令获取 PR 信息：
               - echo "${REPOSITORY}"
               - echo "${PR_NUMBER}"
               - echo "${PR_DATA}"
               - echo "${CHANGED_FILES}"
               - gh pr diff "${PR_NUMBER}"

            2. 审查代码变更，识别以下问题：
               - 严重性：严重、高、中等、低
               - 类型：正确性、效率、可维护性、安全性

            3. 生成一份完整的中文审查报告

            4. 使用 gh 命令提交审查报告：gh pr review "${PR_NUMBER}" --body "你的审查报告" --comment

            ## Guideline

            - 重点关注新增的代码行
            - 只报告实际存在的问题
            - 提供具体的修复建议
            - 使用清晰的严重性标识
            - 保持报告简洁明了

      - name: 'Post PR review failure comment'
        if: |-
          ${{ failure() && steps.iflow_cli_pr_review.outcome == 'failure' }}
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea'
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'
          script: |-
            github.rest.issues.createComment({
              owner: '${{ github.repository }}'.split('/')[0],
              repo: '${{ github.repository }}'.split('/')[1],
              issue_number: '${{ steps.get_pr.outputs.pr_number }}',
              body: '## PR Review Failed\n\nThere is a problem with the PR review automation.\n\nPlease check the action logs for details.'
            })
