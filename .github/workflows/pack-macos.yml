name: Packaging(MacOS)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  PRODUCT: EasyKiConverter
  QT_VERSION: '6.10.1'
  CMAKE_VERSION: '3.22'

jobs:
  pack:
    name: 'Build DMG on ${{ matrix.dist.os }} ${{ matrix.dist.arch }}'
    runs-on: ${{ matrix.dist.os }}
    strategy:
      fail-fast: false
      matrix:
        dist:
          - {
              os: macos-14,
              arch: arm64
            }
          - {
              os: macos-15,
              arch: intel
            }
    env:
      APP_NAME: EasyKiConverter
      DIR_BUILD: build
    steps:
      - name: 'Checkout Source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Get Version Info'
        id: version
        uses: ./.github/actions/get-version

      - name: 'Export Version to Env'
        shell: bash
        run: |
          echo "VERSION=${{ steps.version.outputs.VERSION }}" >> $GITHUB_ENV
          echo "VER_INFO=${{ steps.version.outputs.VER_INFO }}" >> $GITHUB_ENV
          echo "GIT_HASH=${{ steps.version.outputs.GIT_HASH }}" >> $GITHUB_ENV

      - name: 'Setup Build Environment'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'mac'
          qt-target: 'desktop'
          enable-ccache: 'true'
          enable-sccache: 'false'

      - name: 'Configure'
        run: |
          rm -rf "${DIR_BUILD}"
          cmake -B "${DIR_BUILD}" \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF \
            -DVERSION_FROM_CI=${{ env.VERSION }}

      - name: 'Compile'
        run: |
          cmake --build "${DIR_BUILD}" --config RelWithDebInfo --parallel

      - name: 'Create App Bundle'
        run: |
          mkdir -p ${APP_NAME}.app/Contents/MacOS
          mkdir -p ${APP_NAME}.app/Contents/Resources
          cp -r ${DIR_BUILD}/bin/* ${APP_NAME}.app/Contents/MacOS/
          cp -r ${DIR_BUILD}/lib/* ${APP_NAME}.app/Contents/MacOS/ 2>/dev/null || echo "No lib directory"

          if [ -f "resources/icons/app_icon.icns" ]; then
            cp resources/icons/app_icon.icns ${APP_NAME}.app/Contents/Resources/AppIcon.icns
          fi

          cat > ${APP_NAME}.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>EasyKiconverter_Cpp_Version</string>
              <key>CFBundleIdentifier</key>
              <string>com.tangsangsimida.EasyKiConverter</string>
              <key>CFBundleName</key>
              <string>EasyKiConverter</string>
              <key>CFBundleDisplayName</key>
              <string>EasyKiConverter</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF

          # 使用 macdeployqt 部署 Qt 运行时库和插件
          macdeployqt ${APP_NAME}.app -qmldir=src -verbose=1

      - name: 'Create DMG'
        run: |
          hdiutil create -volname EasyKiConverter \
            -srcfolder ${APP_NAME}.app \
            -ov -format UDZO \
            ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg

      - name: 'SHA256Sum of DMG'
        run: |
          cd "$GITHUB_WORKSPACE/" || { >&2 echo "Cannot cd to '$GITHUB_WORKSPACE/'!"; exit 11 ; }
          shasum ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg | tee ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg.sha256sum

      - name: 'Artifact Upload'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT }}-${{ env.VER_INFO }}-artifact-macos-${{ matrix.dist.arch }}
          path: |
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg.sha256sum
          overwrite: true

      - name: 'Upload Release Asset'
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.dist.arch }}.dmg.sha256sum
          generate_release_notes: false
          fail_on_unmatched_files: false
