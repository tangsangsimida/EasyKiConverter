name: Packaging(MacOS)

on:
  push:
    branches: [ 'master', 'main' ]
    tags:
      - 'v*'
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false

env:
  PRODUCT: EasyKiConverter
  QT_VERSION: '6.10.1'

jobs:
  dmg-pack:
    name: 'Build DMG on ${{ matrix.dist.os }} ${{ matrix.dist.arch }}'
    runs-on: ${{ matrix.dist.os }}
    strategy:
      fail-fast: false
      matrix:
        dist:
          - {
              os: macos-14,
              arch: arm64
            }
          - {
              os: macos-13,
              arch: intel
            }
    env:
      APP_NAME: EasyKiConverter
      DIR_BUILD: build
    steps:
      - name: 'Checkout Source code'
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Checkout Source code'
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: 'Set env & Print version'
        shell: bash
        run: |
          last_committed_tag=$(git tag -l --sort=-v:refname | head -1)
          git_revno=$(git rev-list $(git describe --tags --abbrev=0)..HEAD --count)
          git_hash=$(git rev-parse --short HEAD)
          ver_info=${last_committed_tag}+git${git_revno}.${git_hash}
          echo "=======EASYKICONVERTER VERSION========"
          echo ${last_committed_tag:1}
          echo "Details: ${ver_info}"
          echo "======================================"
          echo "VERSION=3.0.1" >> $GITHUB_ENV
          echo "VER_INFO=${ver_info}" >> $GITHUB_ENV
          echo "GIT_HASH=${git_hash}" >> $GITHUB_ENV

      - name: 'Setup CMake'
        uses: jwlawson/actions-setup-cmake@v2.2
        with:
          cmake-version: '3.16'

      - name: 'Install Qt'
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'mac'
          target: 'desktop'
          modules: 'qtbase qtquick qtdeclarative qtquickcontrols2 qtnetworkauth'
          cache: true

      - name: 'Configure'
        run: |
          rm -rf "${DIR_BUILD}"
          cmake -B "${DIR_BUILD}" \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF

      - name: 'Compile'
        run: |
          cmake --build "${DIR_BUILD}" --config RelWithDebInfo --parallel

      - name: 'Create App Bundle'
        run: |
          mkdir -p ${APP_NAME}.app/Contents/MacOS
          mkdir -p ${APP_NAME}.app/Contents/Resources
          cp -r ${DIR_BUILD}/bin/* ${APP_NAME}.app/Contents/MacOS/
          cp -r ${DIR_BUILD}/lib/* ${APP_NAME}.app/Contents/MacOS/ 2>$null || echo "No lib directory"
          
          if [ -f "resources/icons/app_icon.icns" ]; then
            cp resources/icons/app_icon.icns ${APP_NAME}.app/Contents/Resources/AppIcon.icns
          fi

          cat > ${APP_NAME}.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>EasyKiconverter_Cpp_Version</string>
              <key>CFBundleIdentifier</key>
              <string>com.tangsangsimida.EasyKiConverter</string>
              <key>CFBundleName</key>
              <string>EasyKiConverter</string>
              <key>CFBundleDisplayName</key>
              <string>EasyKiConverter</string>
              <key>CFBundleVersion</key>
              <string>3.0.1</string>
              <key>CFBundleShortVersionString</key>
              <string>3.0.1</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF

      - name: 'Create DMG'
        run: |
          hdiutil create -volname EasyKiConverter \
            -srcfolder ${APP_NAME}.app \
            -ov -format UDZO \
            ${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg

      - name: 'SHA256Sum of DMG'
        run: |
          cd "$GITHUB_WORKSPACE/" || { >&2 echo "Cannot cd to '$GITHUB_WORKSPACE/'!"; exit 11 ; }
          sha256sum ${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg | tee ${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg.sha256sum

      - name: 'Artifact Upload'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT }}-${{ env.VER_INFO }}-artifact-macos-${{ matrix.dist.arch }}
          path: |
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg.sha256sum
          overwrite: true

      - name: 'Upload Release Asset'
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-${{ matrix.dist.arch }}.dmg.sha256sum
          generate_release_notes: true