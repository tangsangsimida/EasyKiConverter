name: 'Automated Issue Triage'

on:
  issues:
    types:
      - 'opened'
      - 'reopened'
  issue_comment:
    types:
      - 'created'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'è¦åˆ†ç±»çš„ Issue ç¼–å·'
        required: true
        type: number

concurrency:
  group: '${{ github.workflow }}-${{ github.event.issue.number || inputs.issue_number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read
  issues: write
  statuses: write

jobs:
  triage-issue:
    if: |-
      github.event_name == 'issues' ||
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@iflow-cli /triage') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set issue context
        id: issue_context
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> "$GITHUB_OUTPUT"
            ISSUE_DATA=$(gh api repos/${{ github.repository }}/issues/${{ inputs.issue_number }} --jq '{title: .title, body: .body}')
            echo "title=$(echo "$ISSUE_DATA" | jq -r '.title // ""')" >> "$GITHUB_OUTPUT"
            echo "body=$(echo "$ISSUE_DATA" | jq -r '.body // ""')" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
            echo "title=${{ github.event.issue.title }}" >> "$GITHUB_OUTPUT"
            echo "body=${{ github.event.issue.body }}" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run iFlow CLI Issue Triage (Chinese Mode)
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: iflow_cli_issue_triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ steps.issue_context.outputs.title }}
          ISSUE_BODY: ${{ steps.issue_context.outputs.body }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: qwen3-coder-plus
          timeout: "3600"
          debug: "true"
          prompt: |
            ## è§’è‰²
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ GitHub Issue åˆ†ç±»åŠ©æ‰‹ã€‚è¯·ç”¨ä¸­æ–‡æ€è€ƒï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œã€‚

            ## ä»»åŠ¡ç›®æ ‡
            åˆ†æå½“å‰ Issue çš„æ ‡é¢˜å’Œå†…å®¹ï¼Œä¸ºå…¶æ‰“ä¸Šæœ€åˆé€‚çš„ç°æœ‰æ ‡ç­¾ï¼ˆä»…é™ä»“åº“ä¸­å·²å­˜åœ¨çš„æ ‡ç­¾ï¼‰ã€‚
            æ ‡ç­¾æ ¼å¼åº”ä¸ºï¼š`kind/*`ï¼ˆå¦‚ kind/bugï¼‰ã€`priority/*`ï¼ˆå¦‚ priority/p1ï¼‰ç­‰ã€‚

            ## æ“ä½œæ­¥éª¤
            1. é¦–å…ˆè¿è¡Œå‘½ä»¤ï¼š`gh label list` è·å–ä»“åº“ä¸­æ‰€æœ‰å¯ç”¨æ ‡ç­¾ã€‚
            2. ä»”ç»†é˜…è¯» Issue æ ‡é¢˜ï¼šâ€œ $ {ISSUE_TITLE}â€ å’Œå†…å®¹ï¼šâ€œ $ {ISSUE_BODY}â€ã€‚
            3. åˆ¤æ–­ Issue ç±»å‹ï¼ˆä¾‹å¦‚ï¼šbugã€åŠŸèƒ½å¢å¼ºã€æ–‡æ¡£æ”¹è¿›ã€ä»£ç æ¸…ç†ç­‰ï¼‰å’Œä¼˜å…ˆçº§ï¼ˆp0 è‡³ p3ï¼‰ã€‚
            4. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸º Issue æ·»åŠ æ ‡ç­¾ï¼š
               `gh issue edit " $ {ISSUE_NUMBER}" --add-label "label1,label2"`
            5. å¦‚æœå­˜åœ¨ "status/needs-triage" æ ‡ç­¾ï¼Œè¯·ç§»é™¤å®ƒï¼š
               `gh issue edit " $ {ISSUE_NUMBER}" --remove-label "status/needs-triage"`

            ## é‡è¦è§„åˆ™
            - â— åªèƒ½ä½¿ç”¨ `gh label list` è¿”å›çš„æ ‡ç­¾ï¼Œç¦æ­¢è‡ªåˆ›æ ‡ç­¾ã€‚
            - âŒ ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºï¼Œä¸è¦ä¿®æ”¹ Issue å†…å®¹ã€‚
            - ğŸ” ä»…å¤„ç†å½“å‰ Issueï¼ˆç¼–å·ï¼š $ {ISSUE_NUMBER}ï¼‰ã€‚
            - ğŸ“Œ å¿…é¡»åŒæ—¶è€ƒè™‘ç±»å‹å’Œä¼˜å…ˆçº§ï¼Œå°½å¯èƒ½æ‰“å…¨æ ‡ç­¾ã€‚
            - ğŸ’¬ æ‰€æœ‰ shell å˜é‡å¿…é¡»å†™ä½œ " $ {VAR}"ï¼ˆå¸¦åŒå¼•å·å’ŒèŠ±æ‹¬å·ï¼‰ã€‚

            ## è¾“å‡ºè¦æ±‚
            æ‰§è¡ŒæˆåŠŸåæ— éœ€é¢å¤–è¾“å‡ºã€‚è‹¥å› æƒé™æˆ–æ ‡ç­¾ä¸å­˜åœ¨è€Œå¤±è´¥ï¼Œè¯·ç¡®ä¿é”™è¯¯ä¿¡æ¯æ¸…æ™°ã€‚

      - name: Post Success Comment (Optional)
        if: success() && (github.event_name != 'issues')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue_context.outputs.number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: 'âœ… Issue å·²æˆåŠŸå®Œæˆè‡ªåŠ¨åˆ†ç±»ï¼ç›¸å…³æ ‡ç­¾å·²åº”ç”¨ã€‚'
            });

      - name: Post Failure Comment
        if: failure() && steps.iflow_cli_issue_triage.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue_context.outputs.number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âŒ è‡ªåŠ¨åˆ†ç±»å¤±è´¥ã€‚\n\nè¯·æŸ¥çœ‹ [Action è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä»¥æ’æŸ¥é—®é¢˜ã€‚\n\nå¸¸è§åŸå› ï¼š\n- ä»“åº“ä¸­ç¼ºå°‘å¿…è¦çš„æ ‡ç­¾ï¼ˆå¦‚ kind/bugï¼‰\n- IFLOW_API_KEY æ— æ•ˆæˆ–é…é¢ä¸è¶³\n- æ¨¡å‹ä¸´æ—¶ä¸å¯ç”¨`
            });
