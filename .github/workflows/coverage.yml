name: Code Coverage

on:
  push:
    branches: [ 'master', 'main' ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  pull_request:
    branches: [ 'master', 'main' ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

env:
  QT_VERSION: '6.10.1'
  CMAKE_VERSION: '3.16'

jobs:
  code-coverage:
    name: 'Code Coverage'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Source code'
        if: github.event_name == 'push'
        uses: actions/checkout@v4

      - name: 'Checkout Source code'
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: 'Checkout Source code'
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: 'Install lcov'
        run: |
          sudo apt-get -y -qq update
          sudo apt-get -y --no-install-recommends install lcov

      - name: 'Setup Build Environment'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'linux'
          qt-target: 'desktop'
          enable-ccache: 'true'
          enable-sccache: 'false'

      - name: 'Configure main project with coverage'
        run: |
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage" \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF

      - name: 'Build main project with coverage'
        run: |
          cmake --build build --config Debug --parallel

      - name: 'Configure tests with coverage'
        run: |
          cd tests
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage"

      - name: 'Build tests with coverage'
        run: |
          cd tests
          cmake --build build --config Debug

      - name: 'Run tests with coverage'
        run: |
          cd tests/build
          ./test_component_service
          ./test_export_service
          ./test_config_service
          ./test_export_service_pipeline
          ./test_component_data_collector
          ./test_layer_mapping
          ./test_uuid_extraction

      - name: 'Generate coverage report'
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info 'tests/*' --output-file coverage.info
          lcov --list coverage.info --output-file coverage.txt

      - name: 'Upload coverage to Codecov'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: 'Upload coverage artifact'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.info
            coverage.txt
          overwrite: true
