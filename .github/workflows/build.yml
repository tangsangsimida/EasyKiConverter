name: Build

on:
  push:
    branches: ['master', 'ci_test']
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  pull_request:
    branches: ['master', 'dev', 'ci_test']
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  packages: read

env:
  BUILD_TYPE: RelWithDebInfo
  QT_VERSION: '6.10.1'
  CMAKE_VERSION: '3.22'

jobs:
  linux-build:
    name: 'Build Linux (Docker)'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # 使用统一构建环境
    container:
      image: ghcr.io/tangsangsimida/easykiconverter/build-env:latest
      options: --user root

    steps:
      - name: 'Checkout Source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Fix Git Safe Directory'
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: 'Configure CMake with CCache'
        run: |
          # 配置 Git 确保 FetchContent 能正常工作
          git config --global http.sslVerify false
          git config --global http.postBuffer 524288000

          cmake -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF \
            -DCI=ON \
            -DFETCHCONTENT_FULLY_DISCONNECTED=OFF \
            -DFETCHCONTENT_UPDATES_DISCONNECTED=OFF \
            -DFETCHCONTENT_QUIET=OFF

      - name: 'Build'
        run: |
          cmake --build build --config $BUILD_TYPE --parallel 16

  windows-build:
    name: 'Build Windows'
    runs-on: windows-2022
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'Windows MSVC'
            platform: 'msvc2019_64'
            generator: 'Visual Studio 17 2022'
            arch: 'x64'
    steps:
      - name: 'Checkout Source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup MSVC'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
          toolset: '14.2'

      - name: 'Setup vcpkg'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'vcpkg.json'
          runVcpkgInstall: true

      - name: 'Setup Build Environment (MSVC)'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'windows'
          qt-target: 'desktop'
          qt-arch: 'win64_msvc2022_64'
          enable-ccache: 'false'
          enable-sccache: 'true'

      - name: 'Configure CMake (MSVC) with sccache and vcpkg'
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
            -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache `
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DCI=ON

      - name: 'Build'
        run: |
          cmake --build build --config $env:BUILD_TYPE --parallel 16

  macos-build:
    name: 'Build macOS'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'macOS ARM64'
            os: macos-14
          - name: 'macOS Intel'
            os: macos-15
    steps:
      - name: 'Checkout Source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup Build Environment'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'mac'
          qt-target: 'desktop'
          enable-ccache: 'true'
          enable-sccache: 'false'

      - name: 'Configure CMake with CCache'
        run: |
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF \
            -DCI=ON

      - name: 'Build'
        run: |
          cmake --build build --config $BUILD_TYPE --parallel 4
