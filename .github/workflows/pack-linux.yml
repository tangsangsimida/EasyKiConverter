name: Packaging(Linux)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false

env:
  PRODUCT: EasyKiConverter
  RELEASE: 1
  QT_VERSION: '6.10.1'
  CMAKE_VERSION: '3.22'

jobs:
  appimage-pack:
    name: 'Build AppImage on ${{ matrix.config.name }}'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        config:
          - {
              name: 'Ubuntu 22.04',
              os: 'ubuntu',
              symbol: 'focal',
              arch: 'amd64'
            }
    steps:
      - name: 'Checkout Source code'
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Checkout Source code'
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: 'Get Version from Git Tag'
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then #如果是 Tag 触发，使用 Tag 名(去掉 v 前缀)
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev"            # 如果不是 Tag，使用默认开发版本
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Extracted version: ${VERSION}"

      - name: 'Set env & Print version'
        shell: bash
        run: |
          last_committed_tag=$(git tag -l --sort=-v:refname | head -1)
          git_revno=$(git rev-list $(git describe --tags --abbrev=0)..HEAD --count)
          git_hash=$(git rev-parse --short HEAD)
          ver_info=${last_committed_tag}+git${git_revno}.${git_hash}
          echo "=======EASYKICONVERTER VERSION========"
          echo ${last_committed_tag:1}
          echo "Details: ${ver_info}"
          echo "======================================"
          echo "VER_INFO=${ver_info}" >> $GITHUB_ENV
          echo "GIT_HASH=${git_hash}" >> $GITHUB_ENV

      - name: 'Install AppImage Dependencies'
        run: |
          sudo apt-get -y -qq update
          sudo apt-get -y --no-install-recommends install \
            fuse \
            appstream \
            hicolor-icon-theme \
            openssl \
            ca-certificates

      - name: 'Setup Build Environment'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'linux'
          qt-target: 'desktop'
          enable-ccache: 'true'
          enable-sccache: 'false'

      - name: 'Set Qt Environment Variables'
        run: |
          echo "Qt6_DIR=$Qt6_DIR" >> $GITHUB_ENV
          echo "Qt6_ROOT_DIR=$Qt6_DIR" >> $GITHUB_ENV
          echo "Qt6_PLUGIN_PATH=$Qt6_DIR/plugins" >> $GITHUB_ENV
          echo "QML2_IMPORT_PATH=$Qt6_DIR/qml" >> $GITHUB_ENV
          echo "Qt6_DIR=$Qt6_DIR"
          echo "Qt6_ROOT_DIR=$Qt6_DIR"
          echo "Qt6_PLUGIN_PATH=$Qt6_DIR/plugins"
          echo "QML2_IMPORT_PATH=$Qt6_DIR/qml"

      - name: 'Download linuxdeploy'
        run: |
          curl -L -o linuxdeploy-x86_64.AppImage "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          chmod a+x linuxdeploy-x86_64.AppImage
          echo "LINUXDEPLOY_BIN=${PWD}/linuxdeploy-x86_64.AppImage" >> $GITHUB_ENV

      - name: 'Download linuxdeployqt-plugin-qt'
        run: |
          curl -L -o linuxdeploy-plugin-qt-x86_64.AppImage "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
          chmod a+x linuxdeploy-plugin-qt-x86_64.AppImage

      - name: 'Build application'
        run: |
          set -x
          APPIMAGE_DST_PATH=$GITHUB_WORKSPACE/${PRODUCT}.AppDir
          mkdir -p ${APPIMAGE_DST_PATH}

          cd $GITHUB_WORKSPACE
          cmake -B build \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_PREFIX_PATH=${Qt6_DIR} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF \
            -DVERSION_FROM_CI=${{ env.VERSION }}
          cmake --build build --config RelWithDebInfo --parallel
          cmake --install build --prefix ${APPIMAGE_DST_PATH}/usr
          rm -rf ${APPIMAGE_DST_PATH}/usr/include

          export QMAKE=${Qt6_DIR}/bin/qmake
          export QML_SOURCES_PATHS=${Qt6_DIR}/qml
          ${LINUXDEPLOY_BIN} --appdir ${APPIMAGE_DST_PATH} --plugin qt --output appimage

          mv $GITHUB_WORKSPACE/EasyKiConverter-${VERSION}-x86_64.AppImage \
             $GITHUB_WORKSPACE/${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}.x86_64.AppImage

      - name: 'SHA256Sum of appimage'
        run: |
          cd "$GITHUB_WORKSPACE/" || { >&2 echo "Cannot cd to '$GITHUB_WORKSPACE/'!"; exit 11 ; }
          sha256sum ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}.x86_64.AppImage | tee ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}.x86_64.AppImage.sha256sum

      - name: 'Artifact Upload'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT }}-${{ env.VER_INFO }}-artifact-appimage-x86_64
          path: |
            ${{ github.workspace }}/${PRODUCT}-*.x86_64.AppImage
            ${{ github.workspace }}/${PRODUCT}-*.x86_64.AppImage.sha256sum
          overwrite: true

      - name: 'Upload Release Asset'
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}.x86_64.AppImage
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}.x86_64.AppImage.sha256sum
          generate_release_notes: true
          draft: true
          prerelease: false
          fail_on_unmatched_files: false

  tarball-pack:
    name: 'Build tarball on ${{ matrix.config.name }}'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        config:
          - {
              name: 'Ubuntu 22.04',
              os: 'ubuntu-22.04'
            }
    steps:
      - name: 'Checkout Source code'
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Checkout Source code'
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: 'Get Version from Git Tag'
        shell: bash
        run: |
          # 如果是 Tag 触发，使用 Tag 名 (去掉 v 前缀)
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # 如果不是 Tag，使用默认开发版本
            VERSION="dev"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Extracted version: ${VERSION}"

      - name: 'Set env & Print version'
        shell: bash
        run: |
          last_committed_tag=$(git tag -l --sort=-v:refname | head -1)
          git_revno=$(git rev-list $(git describe --tags --abbrev=0)..HEAD --count)
          git_hash=$(git rev-parse --short HEAD)
          ver_info=${last_committed_tag}+git${git_revno}.${git_hash}
          echo "VER_INFO=${ver_info}" >> $GITHUB_ENV
          echo "GIT_HASH=${git_hash}" >> $GITHUB_ENV

      - name: 'Setup Build Environment'
        uses: ./.github/actions/setup-env
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}
          qt-version: ${{ env.QT_VERSION }}
          qt-host: 'linux'
          qt-target: 'desktop'
          enable-ccache: 'true'
          enable-sccache: 'false'

      - name: 'Set Qt Environment Variables'
        run: |
          echo "Qt6_DIR=$Qt6_DIR" >> $GITHUB_ENV
          echo "Qt6_ROOT_DIR=$Qt6_DIR" >> $GITHUB_ENV
          echo "Qt6_PLUGIN_PATH=$Qt6_DIR/plugins" >> $GITHUB_ENV
          echo "QML2_IMPORT_PATH=$Qt6_DIR/qml" >> $GITHUB_ENV
          echo "Qt6_DIR=$Qt6_DIR"
          echo "Qt6_ROOT_DIR=$Qt6_DIR"
          echo "Qt6_PLUGIN_PATH=$Qt6_DIR/plugins"
          echo "QML2_IMPORT_PATH=$Qt6_DIR/qml"

      - name: 'Build application'
        run: |
          set -x
          cd $GITHUB_WORKSPACE
          cmake -B build \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_PREFIX_PATH=${Qt6_DIR} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DENABLE_SYMBOL_FOOTPRINT_DEBUG_EXPORT=OFF \
            -DVERSION_FROM_CI=${{ env.VERSION }}
          cmake --build build --config RelWithDebInfo --parallel

      - name: 'Create tarball'
        run: |
          mkdir -p ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}
          cp -r build/bin/* ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}/
          cp -r build/lib/* ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}/ 2>/dev/null || echo "No lib directory"
          cp README*.md ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}/ 2>/dev/null || echo "No README files"
          cp LICENSE ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}/
          tar czf ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}/

      - name: 'SHA256Sum of tarball'
        run: |
          cd "$GITHUB_WORKSPACE/" || { >&2 echo "Cannot cd to '$GITHUB_WORKSPACE/'!"; exit 11 ; }
          sha256sum ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz | tee ${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz.sha256sum

      - name: 'Artifact Upload'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT }}-${{ env.VER_INFO }}-artifact-tarball-${{ matrix.config.os }}
          path: |
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz
            ${{ github.workspace }}/${PRODUCT}-${VERSION}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz.sha256sum
          overwrite: true

      - name: 'Upload Release Asset'
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz
            ${{ github.workspace }}/${{ env.PRODUCT }}-${{ env.VERSION }}-g${{ env.GIT_HASH }}-${{ matrix.config.os }}.tar.gz.sha256sum
          generate_release_notes: true
          fail_on_unmatched_files: false
